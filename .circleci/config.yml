version: "2.1"
jobs:
  build_primary:
    working_directory: ~/cookbook
    docker:
      - image: l.gcr.io/google/bazel:0.29.0
    steps:
      - checkout
      - restore_cache:
          key: "v1-bazel-cache"
      - run: cp .circleci/bazel.rc /etc/bazel.bazelrc
      - run: echo "1.0.$CIRCLE_BUILD_NUM" > version_file
      - run: bazel build //...
      - run: bazel test //...
      - run: |
          mkdir tests
          find -L bazel-testlogs -name 'test.xml' -printf '%h\n' | xargs -n1 -I{} cp -r {} tests
          mkdir artifacts
          find -L bazel-bin -name '*.deb' -exec cp {} artifacts \;
      - store_test_results:
          path: tests
      - store_artifacts:
          path: artifacts/punchcard.deb
      - save_cache:
          key: "v1-bazel-cache"
          paths:
            - "/home/circleci/.cache/bazel"
  build_ui:
    docker:
      - image: circleci/openjdk:8u181-jdk-node-browsers
    steps:
      - checkout
      - run: yarn
      - run: yarn workspaces run build
      - run: yarn workspaces run test

workflows:
  version: 2
  full_build:
    jobs:
    - build_primary
    - build_ui
